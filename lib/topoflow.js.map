{"version":3,"sources":["../src/topoflow.js"],"names":["d3","Flow","config","Nodes","Links","sourceNode","selectedElement","optionGroup","currentMouseXY","rwaElnContainer","document","querySelector","eln","classList","add","hasOwnProperty","initContextMenu","svg","select","style","attr","append","genUUID","height","pathGroup","nodeGroup","initDefs","initSvgEvent","contextmenu","render","onNodeContextMenuRender","bind","container","onClick","nodeInfo","iteminfo","contextmenuClick","call","onDataChange","defs","linkTemplate","dragLine","dragLink","innerHTML","arrowDefsDom","remove","selectAll","classed","onClearActiveElement","nodes","nodeIDs","Object","keys","map","item","selected","then","zoom","on","event","transform","scaleExtent","readOnly","xy","mouse","x","y","linkPoint","DragLinkEvent","drag","d","id","sourceEvent","target","parentNode","flag","forEach","v","nodeID","targetNode","addLink","point","onDragLink","nodaDrag","hotKey","nodeMouseXY","dragEvent","linksID","link","linkID","from","to","moveLink","addEventListener","e","keyCode","type","deleteNode","deleteLink","node","onDeleteNode","clearAllActiveElement","onNodeClick","nodeTemplate","template","width","preventDefault","show","onSelectNode","selectNode","renderNode","console","warn","operatingPoint","deleteAble","del_btn","points","calculateLinkPoint","length","gid","path"],"mappings":"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","file":"topoflow.js","sourcesContent":["import * as d3 from 'd3';\n\nimport contextmenu from './lib/contextmenu';\nimport mathLib from './lib/math';\nimport common from './lib/common';\n\nimport './styles/index.css';\n\nexport default class Flow {\n    // 设置默认值\n    constructor(config) {\n        this.config = config; // 初始化配置参数\n\n        this.Nodes = {}; // 当前画布中的节点信息(实时更新)\n        this.Links = {}; // 当前画布的线条信息\n        this.sourceNode = {}; //  源节点信息               \n        this.selectedElement = null; //当前选中节点的ID\n        this.optionGroup = null;  // 操作按钮元素        \n        this.currentMouseXY = {};\n\n\n        this.rwaElnContainer = document.querySelector(this.config.eln);\n\n        this.rwaElnContainer.classList.add('topoflow-container');\n\n        if (this.config.hasOwnProperty('onNodeContextMenuRender')) {\n            this.initContextMenu();\n        }\n\n        // 初始化画布\n        this.svg = d3\n            .select(config.eln)\n            .style('outline', 'none')\n            .attr('tabIndex', '0')\n            .append('svg')\n            .attr('id', `svg_${common.genUUID()}`)\n            .attr('width', '100%')\n            .attr('height', this.config.height);\n\n        // 初始化路径组信息\n        this.pathGroup = this.svg.append('svg:g').attr('class', 'data-flow-path-group');\n        this.nodeGroup = this.svg.append('svg:g').attr('class', 'data-flow-node-group');\n    }\n\n    // 组件初始化方法调用\n    init() {\n        this.initDefs();\n        this.initSvgEvent();\n    }\n\n\n    initContextMenu() {\n        // 初始化右键菜单\n        this.contextmenu = new contextmenu({\n            render: this.config.onNodeContextMenuRender.bind(this),\n            container: this.rwaElnContainer,\n            onClick: (nodeInfo, iteminfo) => {\n                if (!!this.config.contextmenuClick) {\n                    this.config.contextmenuClick.call(this, nodeInfo, iteminfo);\n                }\n            }\n        });\n    }\n\n    // 当图形发生变更的时候进行图形的变化\n    onDataChange() {\n        this.config.onDataChange();\n    }\n\n    // 初始化定义元素，如箭头\n    initDefs() {\n        let defs = this.svg.append('svg:defs').attr('id', 'arrow-defs');\n\n        // 自定义\n        if (this.config.hasOwnProperty('linkTemplate') && this.config.linkTemplate.hasOwnProperty('defs')) {\n            this.config.linkTemplate.defs(defs);\n        } else {\n            defs.append('svg:marker')\n                .attr('id', 'end-arrow')\n                .attr('viewBox', '0 -5 10 10')\n                .attr('refX', 6)\n                .attr('markerWidth', 5)\n                .attr('markerHeight', 5)\n                .attr('orient', 'auto')\n                .append('svg:path')\n                .attr('d', 'M0,-5L10,0L0,5');\n        }\n\n        this.dragLine = this.pathGroup.append('svg:path');\n        if (this.config.hasOwnProperty('linkTemplate') && this.config.linkTemplate.hasOwnProperty('dragLink')) {\n            this.config.linkTemplate.dragLink(this.dragLine)\n        } else {\n            this.dragLine.style('fill', 'white').style('marker-end', 'url(#end-arrow)').attr('class', 'dragline hide').attr('d', 'M0,0L0,0');\n        }\n    }\n\n    // 重置，将会删掉所有的线条和节点\n    reset() {\n        if (this.rwaElnContainer !== null) {\n            let pathGroup = this.rwaElnContainer.querySelector('.data-flow-path-group');\n            if (!!pathGroup) {\n                pathGroup.innerHTML = '';\n            }\n            let nodeGroup = this.rwaElnContainer.querySelector('.data-flow-node-group');\n            if (!!nodeGroup) {\n                nodeGroup.innerHTML = '';\n            }\n\n            let arrowDefsDom = this.rwaElnContainer.querySelector('#arrow-defs');\n            if (!!arrowDefsDom) {\n                arrowDefsDom.remove();\n            }\n        }\n        this.Nodes = [];\n        this.Links = [];\n        this.initDefs();\n        this.onDataChange();\n    }\n\n    // 清理所有选中的元素信息\n    clearAllActiveElement() {\n\n        this.selectedElement = null;\n\n        d3.selectAll('.link').style('marker-end', 'url(#end-arrow)');\n        d3.selectAll('.node').classed('active', false);\n        d3.selectAll('.link').classed('active', false);\n\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n\n        if (!!this.config.onClearActiveElement) {\n            this.config.onClearActiveElement();\n        }\n\n        let nodes = this.Nodes;\n        let nodeIDs = Object.keys(nodes);\n\n        nodeIDs.map(item => {\n            this.Nodes[item].selected = false;\n        });\n        this.onDataChange();\n    }\n\n    zoom() {\n        let then = this;\n\n        // 画布移动缩放        \n        let zoom = d3.zoom().on('zoom', function () {\n            d3.selectAll(`${then.config.eln} .data-flow-path-group, ${then.config.eln} .data-flow-node-group`).attr('transform', d3.event.transform);\n        });\n\n        // 限制缩放的范围\n        zoom.scaleExtent([0.7, 1.5]);\n\n        // 使用移动和缩放并禁用双击\n        this.svg.call(zoom).on('dblclick.zoom', null);\n    }\n\n    // svg画布的事件绑定\n    initSvgEvent() {\n        let then = this;\n\n        this.zoom();\n\n        if (!!!this.config.readOnly) {\n            this.svg.on('mousemove', function () {\n                let xy = d3.mouse(this);\n                then.currentMouseXY = {\n                    x: xy[0],\n                    y: xy[1]\n                };\n            });\n\n            // 鼠标线条的操作\n            let linkPoint = [0, 0, 0, 0];\n            this.DragLinkEvent = d3.drag()\n                .on('start', function (d) {     // 设置线条的起始点\n                    linkPoint = [d3.event.x, d3.event.y];\n                    then.sourceNode = then.Nodes[then.selectedElement.id];\n                })\n                .on('drag', function (d) {      // 线条跟随鼠标位置\n                    linkPoint[2] = d3.event.x;\n                    linkPoint[3] = d3.event.y;\n                    then.dragLine.classed('hide', false).attr('d', `M${linkPoint[0]},${linkPoint[1]}L${linkPoint[2]},${linkPoint[3]}`);\n                })\n                .on('end', function () {\n                    then.dragLine.classed('hide', true);\n                    let classList = d3.event.sourceEvent.target.parentNode.classList;\n                    let flag = 0;\n                    classList.forEach(v => {\n                        if (v === 'data-flow-path-group') {\n                            flag = 1;\n                        } else if (v === 'node') {\n                            flag = 2;\n                        }\n                    });\n\n                    if (flag === 2) {\n                        let nodeID = d3.event.sourceEvent.target.parentNode.id;\n                        let targetNode = then.Nodes[nodeID];\n                        then.addLink(then.sourceNode, targetNode);\n                    }\n                    if (then.config.hasOwnProperty('onDragLink')) {\n                        let point = [d3.event.x, d3.event.y];\n                        then.config.onDragLink(then.sourceNode, point, flag === 2);\n                    }\n\n                    then.sourceNode = {};\n                    then.onDataChange();\n                });\n\n            this.nodaDrag();\n            this.hotKey();\n        }\n    }\n\n    // 节点拖拽事件\n    nodaDrag() {\n        let nodeMouseXY = [];\n        let then = this;\n        this.dragEvent = d3.drag()\n            .on('start', function () {\n                nodeMouseXY = d3.mouse(this);\n                if (!!then.optionGroup) {\n                    then.optionGroup.remove();\n                }\n            })\n            .on('drag', function (d) {\n                let point = {\n                    x: d3.event.x - nodeMouseXY[0],\n                    y: d3.event.y - nodeMouseXY[1]\n                };\n\n                d3.select(this).attr('transform', `translate(${point.x},${point.y})`);\n\n                // 移动节点,线条跟着变化\n                let nodeID = this.id;\n\n                then.Nodes[nodeID].x = point.x;\n                then.Nodes[nodeID].y = point.y;\n\n                let linksID = Object.keys(then.Links);\n                linksID.map(linkID => {\n                    let link = then.Links[linkID];\n                    if (nodeID === link.from || nodeID === link.to) {\n                        then.moveLink(link, linkID);\n                    }\n                });\n            })\n            .on('end', function () {\n                then.onDataChange();\n            });\n    }\n\n    // 删除节点和线条的快捷键\n    hotKey() {\n        let then = this;\n        document.querySelector(this.config.eln).addEventListener('keydown', function (e) {\n            if (!!then.selectedElement && (e.keyCode === 8 || e.keyCode === 46)) {\n                if (then.selectedElement.type === 'node') {\n                    then.deleteNode(then.selectedElement.id);\n                } else {\n                    let link = then.Links[then.selectedElement.id];\n                    then.deleteLink(link);\n                }\n            }\n        });\n    }\n\n    // 删除节点\n    deleteNode(nodeID) {\n        let node = this.Nodes[nodeID];\n        if (!!!node) {\n            return false;\n        }\n\n        if (this.config.hasOwnProperty('onDeleteNode')) {\n            if (!this.config.onDeleteNode(node)) {\n                return;\n            }\n        }\n\n        delete this.Nodes[nodeID];\n        d3.select('#' + nodeID).remove();\n\n        let linksID = Object.keys(this.Links);\n        linksID.map((linkID) => {\n            let link = this.Links[linkID];\n            if (link.from === nodeID || link.to === nodeID) {\n                this.deleteLink(link);\n            }\n        });\n\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n\n        this.onDataChange();\n    }\n\n    // 选中节点\n    selectNode(nodeID) {\n        this.clearAllActiveElement()\n        let nodeInfo = this.Nodes[nodeID];\n        nodeInfo.selected = true;\n\n        let node = d3.select(`#${nodeID}`);\n        node.classed('active', true)\n\n        this.selectedElement = {\n            type: 'node',\n            id: nodeID\n        };\n        this.onNodeClick(node, nodeInfo)\n    }\n\n    // 新增一个节点\n    addNode(nodeInfo) {\n        let then = this;\n\n        if (!!!nodeInfo.id) {\n            nodeInfo.id = 'node_' + common.genUUID();\n        }\n\n        if (!this.config.nodeTemplate.hasOwnProperty(nodeInfo.type)) {\n            return;\n        }\n\n        let template = this.config.nodeTemplate[nodeInfo.type];\n\n        nodeInfo.width = template.width;\n        nodeInfo.height = template.height;\n\n        let node = this.nodeGroup\n            .append('g')\n            .attr('class', 'node')\n            .attr('id', nodeInfo.id)\n            .on('contextmenu', function () {\n                d3.event.preventDefault();\n                if (then.config.hasOwnProperty('onNodeContextMenuRender')) {\n                    then.contextmenu.show(nodeInfo, then.currentMouseXY);\n                }\n            })\n            .on('click', function () {\n                then.config.onSelectNode(this, nodeInfo);\n                then.selectNode(nodeInfo.id);\n                then.onNodeClick(node, nodeInfo);\n            })\n            .attr('transform', `translate(${nodeInfo.x}, ${nodeInfo.y})`);\n\n\n        if (!!this.dragEvent) {\n            node.call(this.dragEvent);\n        }\n\n        // 调用参数定义的        \n        this.config.nodeTemplate[nodeInfo.type].renderNode(node, nodeInfo);\n\n        // 保存节点信息        \n        this.Nodes[nodeInfo.id] = nodeInfo;\n        this.onDataChange();\n        return nodeInfo;\n    }\n\n    onNodeClick(node, nodeInfo) {\n        let then = this;\n        this.sourceNode = nodeInfo;\n        let template = this.config.nodeTemplate[nodeInfo.type];\n        if (!template) {\n            console.warn(`${nodeInfo.type} template not found `);\n            return;\n        }\n\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n\n        this.optionGroup = this.nodeGroup.append('g');\n        if (!!!this.config.readOnly) {\n            this.optionGroup.append('rect')\n                .style('fill', 'none')\n                .style('stroke', '#68a987')\n                .style('stroke-width', '1px')\n                .attr('width', nodeInfo.width)\n                .attr('height', nodeInfo.height)\n                .attr('transform', `translate(${nodeInfo.x}, ${nodeInfo.y}) `);\n\n            template.operatingPoint.forEach((item) => {\n                then.optionGroup\n                    .append('svg:circle')\n                    .attr('class', 'operating-point')\n                    .attr('r', 5)\n                    .attr('fill', 'white')\n                    .attr('stroke', '#06a0e9')\n                    .attr('transform', () => {\n                        if (item === 'right') {\n                            return `translate(${nodeInfo.x + nodeInfo.width}, ${nodeInfo.y + nodeInfo.height / 2})`;\n                        } else if (item === 'left') {\n                            return `translate(${nodeInfo.x}, ${nodeInfo.y + nodeInfo.height / 2})`;\n                        }\n                    }).call(then.DragLinkEvent);\n            });\n\n            if (template.deleteAble) {\n                // 删除按钮\n                let del_btn = this.optionGroup\n                    .append('g')\n                    .attr('class', 'delete-not-btn')\n                    .attr('transform', `translate(${nodeInfo.width + nodeInfo.x}, ${nodeInfo.y}) `);\n\n                del_btn\n                    .append('svg:circle')\n                    .attr('stroke', 'red')\n                    .attr('fill', 'red')\n                    .attr('r', 6);\n\n                del_btn\n                    .append('svg:path')\n                    .attr('stroke', 'white')\n                    .attr('stroke-width', 2)\n                    .attr('d', 'M-3,-3L3,3');\n\n                del_btn\n                    .append('svg:path')\n                    .attr('stroke', 'white')\n                    .attr('stroke-width', 2)\n                    .attr('d', 'M3,-3L-3,3');\n\n                del_btn.on('click', function () {\n                    then.deleteNode(nodeInfo.id);\n                });\n            }\n        }\n    }\n\n    // 移动节点的时候节点相关的线条跟着移动\n    moveLink(link, linkID) {\n        let sourceNode = this.Nodes[link.from];\n        let targetNode = this.Nodes[link.to];\n\n        let points = mathLib.calculateLinkPoint(sourceNode, targetNode, this.config);\n        if (points.length === 4) {\n            d3.select(`#${linkID}`).attr('d', `M${points[0]},${points[1]}L${points[2]}, ${points[3]}`);\n        }\n\n    }\n\n    // 增加线条\n    addLink(sourceNode, targetNode) {\n        let then = this;\n        let gid = 'link_' + common.genUUID();\n        let points = mathLib.calculateLinkPoint(sourceNode, targetNode, this.config);\n\n        if (points.length !== 4) {\n            return ;\n        }\n        \n        let path = this.pathGroup.append('svg:path').attr('id', gid).attr('class', 'link');\n\n        if (this.config.hasOwnProperty('linkTemplate') && this.config.linkTemplate.hasOwnProperty('path')) {\n            this.config.linkTemplate.path(path);\n        } else {\n            path.style('marker-end', 'url(#end-arrow)')\n        }\n\n        path.attr('d', `M${points[0]}, ${points[1]}L${points[2]}, ${points[3]}`)\n            .on('click', () => {\n                then.clearAllActiveElement();\n                path.classed('active', true);\n                then.selectedElement = {\n                    type: 'link',\n                    id: gid\n                };\n            });\n\n        this.Links[gid] = {\n            id: gid,\n            from: sourceNode.id,\n            to: targetNode.id\n        };\n\n        this.onDataChange();\n    }\n\n    deleteLink(link) {\n        delete this.Links[link.id];\n        d3.select(`#${link.id}`).remove();\n        this.onDataChange();\n    }\n}"]}