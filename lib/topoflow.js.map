{"version":3,"sources":["../src/topoflow.js"],"names":["d3","Flow","config","Nodes","Links","sourceNode","selectedElement","optionGroup","currentMouseXY","isSetData","rwaElnContainer","document","querySelector","eln","classList","add","hasOwnProperty","initContextMenu","svg","select","style","attr","append","common","genUUID","width","height","Number","replace","then","force","forceSimulation","Object","values","alphaDecay","forceLink","id","d","distance","forceCollide","radius","forceManyBody","strength","forceCenter","on","forEach","node","domId","x","y","linksID","keys","map","link","linkID","from","to","moveLink","pathGroup","nodeGroup","initDefs","initSvgEvent","contextmenu","render","onNodeContextMenuRender","bind","container","onClick","nodeInfo","iteminfo","contextmenuClick","call","type","remove","onDataChange","defs","linkTemplate","dragLine","dragLink","innerHTML","arrowDefsDom","selectAll","classed","onClearActiveElement","nodes","nodeIDs","item","selected","zoom","event","transform","scaleExtent","nodaDrag","readOnly","xy","mouse","linkPoint","DragLinkEvent","drag","sourceEvent","target","parentNode","flag","v","nodeID","targetNode","addLink","point","onDragLink","hotKey","nodeMouseXY","dragEvent","alphaTarget","restart","addEventListener","e","keyCode","deleteNode","deleteLink","onDeleteNode","clearAllActiveElement","onNodeClick","nodeTemplate","index","length","template","preventDefault","show","contextType","onSelectNode","selectNode","renderNode","alpha","stop","console","warn","operatingPoint","deleteAble","del_btn","points","mathLib","calculateLinkPoint","node2","gid","path","source","onSelectLink","onConnect","promise","onDeleteLink","Promise"],"mappings":"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","file":"topoflow.js","sourcesContent":["import * as d3 from 'd3';\n\nimport contextmenu from './lib/contextmenu';\nimport mathLib from './lib/math';\nimport common from './lib/common';\nimport './styles/index.css';\n\nexport default class Flow {\n    // 设置默认值\n    constructor(config) {\n        this.config = config; // 初始化配置参数\n\n        this.Nodes = {}; // 当前画布中的节点信息(实时更新)\n        this.Links = {}; // 当前画布的线条信息\n        this.sourceNode = {}; //  源节点信息               \n        this.selectedElement = null; //当前选中节点的ID\n        this.optionGroup = null;  // 操作按钮元素        \n        this.currentMouseXY = {};\n        this.isSetData = false; // 是否是回填数据模式\n        this.rwaElnContainer = document.querySelector(this.config.eln);\n\n        this.rwaElnContainer.classList.add('topoflow-container');\n\n        if (this.config.hasOwnProperty('onNodeContextMenuRender')) {\n            this.initContextMenu();\n        }\n        \n        // 初始化画布\n        this.svg = d3\n            .select(config.eln)\n            .style('outline', 'none')\n            .attr('tabIndex', '0')\n            .append('svg')\n            .attr('id', `svg_${common.genUUID()}`)\n            .attr('width', this.config.width ||'100%')\n            .attr('height', this.config.height);\n        // 获取svg画布的宽度\n        let width = Number(this.svg.attr(\"width\").replace('px',''));\n        // 获取svg画布的高度\n        let height = Number(this.svg.attr(\"height\").replace('px',''))\n        // let height = 800;\n          //初始化force\n        let then =this;\n        this.force = d3.forceSimulation(Object.values(this.Nodes))\n        .alphaDecay(config.alphaDecay || 0.05) // 设置alpha衰减系数\n        .force(\"link\", d3.forceLink(Object.values(this.Links)).id(function(d) {  return d.id; }).distance( config.distance || 5)) // distance为连线的距离设置\n        .force('collide', d3.forceCollide().radius(() => config.radius ||50)) // collide 为节点指定一个radius区域来防止节点重叠。\n        .force(\"charge\", d3.forceManyBody().strength( config.strength ||-10))  // 节点间的作用力\n        .force(\"center\",d3.forceCenter(width/2,height/2))\n        // .alpha(1)  // 设置alpha值，让里导向图有初始动力\n        .on('tick', () => {\n            Object.values(this.Nodes).forEach(node => {\n                d3.select(`#${node.domId}`).attr('transform', () => `translate(${node.x},${node.y})`);\n                // d3.select(`#edit-${node.domId}`).attr('transform', () => `translate(${node.x},${node.y})`);\n                let linksID = Object.keys(then.Links);\n                linksID.map(linkID => {\n                    let link = then.Links[linkID];\n                    if (node.id === link.from || node.id === link.to) {\n                        then.moveLink(link, linkID);\n                    }\n                });\n            })\n        })\n        // .restart();   // 启动仿真计时器\n        // 初始化路径组信息\n        this.pathGroup = this.svg.append('svg:g').attr('class', 'data-flow-path-group');\n        this.nodeGroup = this.svg.append('svg:g').attr('class', 'data-flow-node-group');\n    }\n\n    // 组件初始化方法调用\n    init() {\n        this.initDefs();\n        this.initSvgEvent();\n    }\n\n\n    initContextMenu() {\n        // 初始化右键菜单\n        this.contextmenu = new contextmenu({\n            render: this.config.onNodeContextMenuRender.bind(this),\n            container: this.rwaElnContainer,\n            onClick: (nodeInfo, iteminfo) => {\n                if (!!this.config.contextmenuClick) {\n                    this.config.contextmenuClick.call(this, nodeInfo, iteminfo);\n                }\n            }\n        });\n    }\n\n    // 当图形发生变更的时候进行图形的变化\n    onDataChange(type) {\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n        if (!this.isSetData && this.config.hasOwnProperty('onDataChange')) {\n            this.config.onDataChange(type);\n        }\n    }\n\n    // 初始化定义元素，如箭头\n    initDefs() {\n        let defs = this.svg.append('svg:defs').attr('id', 'arrow-defs');\n\n        // 自定义\n        if (this.config.hasOwnProperty('linkTemplate') && this.config.linkTemplate.hasOwnProperty('defs')) {\n            this.config.linkTemplate.defs(defs);\n        } else {\n            defs.append('svg:marker')\n                .attr('id', 'end-arrow')\n                .attr('viewBox', '0 -5 10 10')\n                .attr('refX', 6)\n                .attr('markerWidth', 5)\n                .attr('markerHeight', 5)\n                .attr('orient', 'auto')\n                .append('svg:path')\n                .attr('d', 'M0,-5L10,0L0,5');\n        }\n\n        this.dragLine = this.pathGroup.append('svg:path');\n        if (this.config.hasOwnProperty('linkTemplate') && this.config.linkTemplate.hasOwnProperty('dragLink')) {\n            this.config.linkTemplate.dragLink(this.dragLine)\n        } else {\n            this.dragLine.style('fill', 'white').style('marker-end', 'url(#end-arrow)').attr('class', 'dragline hide').attr('d', 'M0,0L0,0');\n        }\n    }\n\n    // 重置，将会删掉所有的线条和节点\n    reset() {\n        if (this.rwaElnContainer !== null) {\n            let pathGroup = this.rwaElnContainer.querySelector('.data-flow-path-group');\n            if (!!pathGroup) {\n                pathGroup.innerHTML = '';\n            }\n            let nodeGroup = this.rwaElnContainer.querySelector('.data-flow-node-group');\n            if (!!nodeGroup) {\n                nodeGroup.innerHTML = '';\n            }\n\n            let arrowDefsDom = this.rwaElnContainer.querySelector('#arrow-defs');\n            if (!!arrowDefsDom) {\n                arrowDefsDom.remove();\n            }\n        }\n        this.Nodes = {}\n        this.Links = {};\n        this.initDefs();\n        this.onDataChange('reset');\n    }\n\n    // 清理所有选中的元素信息\n    clearAllActiveElement() {\n\n        this.selectedElement = null;\n\n        d3.selectAll('.link').style('marker-end', 'url(#end-arrow)');\n        d3.selectAll('.node').classed('active', false);\n        d3.selectAll('.link').classed('active', false);\n\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n\n        if (!!this.config.onClearActiveElement) {\n            this.config.onClearActiveElement();\n        }\n\n        let nodes = this.Nodes;\n        let nodeIDs = Object.keys(nodes);\n\n        nodeIDs.map(item => {\n            this.Nodes[item].selected = false;\n        });\n        this.onDataChange('clearActive');\n    }\n\n    zoom() {\n        let then = this;\n\n        // 画布移动缩放        \n        let zoom = d3.zoom().on('zoom', function () {\n            d3.selectAll(`${then.config.eln} .data-flow-path-group, ${then.config.eln} .data-flow-node-group`).attr('transform', d3.event.transform);\n        });\n\n        // 限制缩放的范围\n        zoom.scaleExtent([0.2, 1.5]);\n\n        // 使用移动和缩放并禁用双击\n        this.svg.call(zoom).on('dblclick.zoom', null);\n    }\n\n    // svg画布的事件绑定\n    initSvgEvent() {\n        let then = this;\n\n        this.zoom();\n        this.nodaDrag();\n\n        if (!!!this.config.readOnly) {\n            this.svg.on('mousemove', function () {\n                let xy = d3.mouse(this);\n                then.currentMouseXY = {\n                    x: xy[0],\n                    y: xy[1]\n                };\n            });\n\n            // 鼠标线条的操作\n            let linkPoint = [0, 0, 0, 0];\n            this.DragLinkEvent = d3.drag()\n                .on('start', function (d) {     // 设置线条的起始点\n                    linkPoint = [d3.event.x, d3.event.y];\n                    then.sourceNode = then.Nodes[then.selectedElement.id];\n                })\n                .on('drag', function (d) {      // 线条跟随鼠标位置\n                    linkPoint[2] = d3.event.x;\n                    linkPoint[3] = d3.event.y;\n                    then.dragLine.classed('hide', false).attr('d', `M${linkPoint[0]},${linkPoint[1]}L${linkPoint[2]},${linkPoint[3]}`);\n                })\n                .on('end', function () {\n                    then.dragLine.classed('hide', true);\n                    let classList = d3.event.sourceEvent.target.parentNode.classList;\n                    let flag = 0;\n                    classList.forEach(v => {\n                        if (v === 'data-flow-path-group') {\n                            flag = 1;\n                        } else if (v === 'node') {\n                            flag = 2;\n                        }\n                    });\n\n                    if (flag === 2) {\n                        let nodeID = d3.event.sourceEvent.target.parentNode.id;\n                        nodeID = nodeID.replace(\"node_\",\"\")\n                        let targetNode = then.Nodes[nodeID];\n                        then.addLink({from:then.sourceNode.id,to:targetNode.id} );\n                    }\n                    if (then.config.hasOwnProperty('onDragLink')) {\n                        let point = [d3.event.x, d3.event.y];\n                        then.config.onDragLink(then.sourceNode, point, flag === 2);\n                    }\n\n                    then.sourceNode = {};\n                    then.onDataChange('connect');\n                });\n\n            this.hotKey();\n        }\n    }\n\n    // 节点拖拽事件\n    nodaDrag() {\n        let nodeMouseXY = [];\n        let then = this;\n        this.dragEvent = ()=>{\n            return d3.drag()\n            .on('start', function (d) {\n\n                nodeMouseXY = d3.mouse(this);\n                then.force.alphaTarget(0.002).restart();\n                if (!!then.optionGroup) {\n                    then.optionGroup.remove();\n                }\n            })\n            .on('drag', function (d) {\n\n                let point = {\n                    x: d3.event.x - nodeMouseXY[0],\n                    y: d3.event.y - nodeMouseXY[1]\n                };\n\n                d3.select(this).attr('transform', `translate(${point.x},${point.y})`);\n                // 移动节点,线条跟着变化\n                let nodeID = this.id.replace(\"node_\",\"\");\n\n                then.Nodes[nodeID].x = point.x;\n                then.Nodes[nodeID].y = point.y;\n                \n                let linksID = Object.keys(then.Links);\n                linksID.map(linkID => {\n                    let link = then.Links[linkID];\n                    if (nodeID === link.from || nodeID === link.to) {\n                        then.moveLink(link, linkID);\n                    }\n                });\n            })\n            .on('end', function () {\n\n                then.onDataChange('moveNode');\n\n            });\n        }\n    }\n\n    // 删除节点和线条的快捷键\n    hotKey() {\n        let then = this;\n        document.querySelector(this.config.eln).addEventListener('keydown', function (e) {\n            if (!!then.selectedElement && (e.keyCode === 8 || e.keyCode === 46)) {\n                if (then.selectedElement.type === 'node') {\n                    then.deleteNode(then.selectedElement.id);\n                } else {\n                    let link = then.Links[then.selectedElement.id];\n                    then.deleteLink(link);\n                }\n            }\n        });\n    }\n\n    // 删除节点\n    deleteNode(nodeID) {\n        let node = this.Nodes[nodeID];\n        if (!!!node) {\n            return false;\n        }\n\n        if (this.config.hasOwnProperty('onDeleteNode')) {\n            if (!this.config.onDeleteNode(node)) {\n                return;\n            }\n        }\n\n        d3.select('#' + node.domId).remove();\n        delete this.Nodes[nodeID];\n\n        let linksID = Object.keys(this.Links);\n        linksID.map((linkID) => {\n            let link = this.Links[linkID];\n            if (link.from === nodeID || link.to === nodeID) {\n                this.deleteLink(link, 'force');\n            }\n        });\n\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n\n        this.onDataChange('deleteNode');\n    }\n\n    // 选中节点\n    selectNode(nodeID) {\n        this.clearAllActiveElement()\n        let nodeInfo = this.Nodes[nodeID];\n        nodeInfo.selected = true;\n\n        let node = d3.select(`#${nodeInfo.domId}`);\n        node.classed('active', true)\n\n        this.selectedElement = {\n            type: 'node',\n            id: nodeID\n        };\n        this.onNodeClick(node, nodeInfo)\n    }\n\n    // 新增一个节点\n    addNode(nodeInfo) {\n        let then = this;\n\n        if (!!!nodeInfo.id) {\n            nodeInfo.id = common.genUUID();\n        }\n        nodeInfo.domId = 'node_' + nodeInfo.id\n        if (!this.config.nodeTemplate.hasOwnProperty(nodeInfo.type)) {\n            return;\n        }\n        nodeInfo.index = this.Nodes.length; \n        // nodeInfo.fx = null;   // 当节点的fx、fy都为null时，节点处于活动状态\n        // nodeInfo.fy = null;  \n        let template = this.config.nodeTemplate[nodeInfo.type];\n\n        nodeInfo.width = template.width;\n        nodeInfo.height = template.height;\n\n        let node = this.nodeGroup\n            .append('g')\n            .attr('class', 'node')\n            .attr('id', nodeInfo.domId)\n            .on('contextmenu', function () {\n                d3.event.preventDefault();\n                if (then.config.hasOwnProperty('onNodeContextMenuRender')) {\n                    then.contextmenu.show({ contextType: 'node', ...nodeInfo }, then.currentMouseXY);\n                }\n            })\n            .on('click', function () {\n                then.config.onSelectNode(this, nodeInfo);\n                then.selectNode(nodeInfo.id);\n                then.onNodeClick(node, nodeInfo);\n            })\n            .attr('transform', `translate(${nodeInfo.x}, ${nodeInfo.y})`);\n\n\n        if (!!this.dragEvent) {\n            node.call(this.dragEvent());\n        }\n\n        // 调用参数定义的        \n        this.config.nodeTemplate[nodeInfo.type].renderNode(node, nodeInfo);\n\n        // 保存节点信息        \n        this.Nodes[nodeInfo.id] = nodeInfo;\n        this.onDataChange('addNode');\n        then.force.nodes(Object.values(this.Nodes))\n        .force(\"link\", d3.forceLink(Object.values(then.Links)).id(function(d) {return d.id; }).distance(then.config.distance||40)) // distance为连线的距离设置\n        then.force.alpha(then.config.alpha||1).restart();\n\n        return nodeInfo;\n    }\n\n    onNodeClick(node, nodeInfo) {\n        this.force.stop()\n        let then = this;\n        this.sourceNode = nodeInfo;\n        let template = this.config.nodeTemplate[nodeInfo.type];\n        if (!template) {\n            console.warn(`${nodeInfo.type} template not found `);\n            return;\n        }\n\n        if (!!this.optionGroup) {\n            this.optionGroup.remove();\n        }\n\n        this.optionGroup = this.nodeGroup.append('g')\n                                .attr('id', `edit-${nodeInfo.domId}`);\n        if (!!!this.config.readOnly) {\n            this.optionGroup.append('rect')\n                .style('fill', 'none')\n                .style('stroke', '#68a987')\n                .style('stroke-width', '1px')\n                .attr('width', nodeInfo.width)\n                .attr('height', nodeInfo.height)\n                .attr('transform', `translate(${nodeInfo.x}, ${nodeInfo.y}) `);\n\n            template.operatingPoint.forEach((item) => {\n                then.optionGroup\n                    .append('svg:circle')\n                    .attr('class', 'operating-point')\n                    .attr('r', 5)\n                    .attr('fill', 'white')\n                    .attr('stroke', '#06a0e9')\n                    .attr('transform', () => {\n                        if (item === 'right') {\n                            return `translate(${nodeInfo.x + nodeInfo.width}, ${nodeInfo.y + nodeInfo.height / 2})`;\n                        } else if (item === 'left') {\n                            return `translate(${nodeInfo.x}, ${nodeInfo.y + nodeInfo.height / 2})`;\n                        }\n                    }).call(then.DragLinkEvent);\n            });\n\n            if (template.deleteAble) {\n                // 删除按钮\n                let del_btn = this.optionGroup\n                    .append('g')\n                    .attr('class', 'delete-not-btn')\n                    .attr('transform', `translate(${nodeInfo.width + nodeInfo.x}, ${nodeInfo.y}) `);\n\n                del_btn\n                    .append('svg:circle')\n                    .attr('stroke', 'red')\n                    .attr('fill', 'red')\n                    .attr('r', 6);\n\n                del_btn\n                    .append('svg:path')\n                    .attr('stroke', 'white')\n                    .attr('stroke-width', 2)\n                    .attr('d', 'M-3,-3L3,3');\n\n                del_btn\n                    .append('svg:path')\n                    .attr('stroke', 'white')\n                    .attr('stroke-width', 2)\n                    .attr('d', 'M3,-3L-3,3');\n\n                del_btn.on('click', function () {\n                    then.deleteNode(nodeInfo.id);\n                });\n            }\n        }\n    }\n\n    // 移动节点的时候节点相关的线条跟着移动\n    moveLink(link, linkID) {\n        let sourceNode = this.Nodes[link.from];\n        let targetNode = this.Nodes[link.to];\n\n        let points = mathLib.calculateLinkPoint(sourceNode, targetNode, this.config);\n        if (points.length === 4) {\n            d3.select(`#${link.domId}`).attr('d', `M${points[0]},${points[1]}L${points[2]}, ${points[3]}`);\n        }\n\n    }\n\n    // 增加线条\n\n    addLink(link,node2) {\n        if(node2){\n            link = {from:link.id,to:node2.id}\n        }\n        let {to,from,id} = link;\n        let sourceNode = this.Nodes[from];\n        let targetNode = this.Nodes[to];\n        let then = this;\n        let gid = id || common.genUUID();\n        let domId = 'link_' + (id || common.genUUID());\n        let points = mathLib.calculateLinkPoint(sourceNode, targetNode, this.config);\n\n        if (points.length !== 4) {\n            return;\n        }\n\n        let path = this.pathGroup.append('svg:path').attr('id', domId).attr('class', 'link');\n\n        if (this.config.hasOwnProperty('linkTemplate') && this.config.linkTemplate.hasOwnProperty('path')) {\n            this.config.linkTemplate.path(path);\n        } else {\n            path.style('marker-end', 'url(#end-arrow)')\n        }\n\n        this.Links[gid] = {\n            domId: domId,\n            id: gid,\n            from: sourceNode.id,\n            to: targetNode.id,\n            source:sourceNode.id,\n            target:targetNode.id\n        };\n\n        path.attr('d', `M${points[0]}, ${points[1]}L${points[2]}, ${points[3]}`)\n            .on('contextmenu', function () {\n                d3.event.preventDefault();\n                if (then.config.hasOwnProperty('onNodeContextMenuRender')) {\n                    then.contextmenu.show({ contextType: 'link', ...then.Links[gid] }, then.currentMouseXY);\n                }\n            })\n            .on('click', function () {\n                if (!!!then.config.readOnly) {\n                    then.clearAllActiveElement();\n                    path.classed('active', true);\n                    then.config.onSelectLink(this, {...link,domId:domId});\n                }\n                then.selectedElement = {\n                    type: 'link',\n                    id: gid\n                };\n            });\n\n        if (!this.isSetData && this.config.hasOwnProperty('onConnect')) {\n            this.config.onConnect(this.Links[gid], sourceNode, targetNode);\n        }\n\n        then.force.nodes(Object.values(this.Nodes))\n        .force(\"link\", d3.forceLink(Object.values(then.Links)).id(function(d) { return d.id; }).distance(then.config.distance|| 40)) // distance为连线的距离设置\n        then.force.alpha(then.config.alpha||1).restart();\n\n        this.onDataChange('addLink');\n    }\n\n    deleteLink(link, type) {\n        if (type !== 'force' && !this.isSetData && this.config.hasOwnProperty('onDeleteLink')) {\n            let promise = this.config.onDeleteLink(link);\n            if (promise instanceof Promise) {\n                promise.then(r => {\n                    delete this.Links[link.id];\n                    d3.select(`#${link.domId}`).remove();\n                    this.onDataChange('deleteLink');\n                });\n            }\n        } else {\n            delete this.Links[link.id];\n            d3.select(`#${link.domId}`).remove();\n            this.onDataChange('deleteLink');\n        }\n    }\n}"]}